# compose_image â€” Compose multiple images into one using Gemini.
#
# Usage:
#   compose_image <prompt> <output_image> <source_image>...
#
# Arguments:
#   prompt         The text prompt describing the desired composition
#   output_image   Path for the final .webp output
#   source_image   One or more source images (png, webp, jpg/jpeg). Up to 14.
#
# Requires:
#   - GEMINI_API_KEY environment variable
#   - curl, jq, base64 on PATH
#   - extract_image and convert_to_webp commands

set -euo pipefail

ENDPOINT="https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent"

if [[ $# -lt 3 ]]; then
  echo "Usage: $(basename "$0") <prompt> <output_image> <source_image>..." >&2
  exit 1
fi

PROMPT="$1"
OUTPUT_IMAGE="$2"
shift 2

if [[ -z "${GEMINI_API_KEY:-}" ]]; then
  echo "Error: GEMINI_API_KEY is not set." >&2
  exit 1
fi

# Temp files (cleaned up on exit)
RESP_FILE="$(mktemp "${TMPDIR:-/tmp}/nb_resp.XXXXXX.json")"
PNG_FILE="$(mktemp "${TMPDIR:-/tmp}/nb_out.XXXXXX.png")"
trap 'rm -f "$RESP_FILE" "$PNG_FILE"' EXIT

# Encode each source image as a JSON inline_data part
for img in "$@"; do
  if [[ ! -f "$img" ]]; then
    echo "Error: Source image not found: $img" >&2
    exit 1
  fi

  EXT="${img##*.}"
  case "${EXT,,}" in
    png)          MIME="image/png" ;;
    webp)         MIME="image/webp" ;;
    jpg|jpeg)     MIME="image/jpeg" ;;
    *)            echo "Error: Unsupported image format: $EXT" >&2; exit 1 ;;
  esac

  base64 -w0 "$img" | jq -Rs --arg mime "$MIME" \
    '{"inline_data": {"mime_type": $mime, "data": .}}'
done \
  | jq -s --arg prompt "$PROMPT" '{
      "contents": [{"parts": ([{"text": $prompt}] + .)}],
      "generationConfig": {
        "responseModalities": ["TEXT", "IMAGE"]
      }
    }' \
  | curl -s -X POST "$ENDPOINT" \
      -H "x-goog-api-key: ${GEMINI_API_KEY}" \
      -H "Content-Type: application/json" \
      -d @- -o "$RESP_FILE"

# Extract image from response
extract_image "$RESP_FILE" "$PNG_FILE"

# Convert to webp
convert_to_webp "$PNG_FILE" "$OUTPUT_IMAGE"

echo "Saved composed image to: $OUTPUT_IMAGE"
