
set -euo pipefail

RESP="$1"
OUT="$2"

TMPB64=$(mktemp "${TMPDIR:-/tmp}/nb_b64.XXXXXX")
trap 'rm -f "$TMPB64"' EXIT

# Check for API errors first
ERROR=$(tr -d '\000-\010\013\014\016-\037' < "$RESP" \
  | jq -r '.error.message // empty' 2>/dev/null)
if [[ -n "$ERROR" ]]; then
  echo "API error: $ERROR" >&2
  exit 1
fi

# Extract base64 image data to intermediate file
tr -d '\000-\010\013\014\016-\037' < "$RESP" \
  | jq -r '[.candidates[0].content.parts[]
    | select(has("inlineData") or has("inline_data"))]
    | .[0] | (.inlineData // .inline_data).data' \
  > "$TMPB64"

if [[ ! -s "$TMPB64" ]]; then
  echo "No image data found in response." >&2
  echo "Response structure:" >&2
  tr -d '\000-\010\013\014\016-\037' < "$RESP" \
    | jq 'del(.. | .data? // empty)' >&2
  exit 1
fi

# Decode to output file
base64 -d "$TMPB64" > "$OUT"

if [[ "${DEBUG:-0}" == "1" ]]; then
  echo "Saved $(wc -c < "$OUT") bytes to $OUT"

  # Print text commentary if present
  TEXT=$(tr -d '\000-\010\013\014\016-\037' < "$RESP" \
    | jq -r '.candidates[0].content.parts[] | select(has("text")) | .text' 2>/dev/null)
  if [[ -n "$TEXT" ]]; then
    echo "---"
    echo "$TEXT"
  fi
fi
